<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timer Leaderboard - Auto Sync to Google Sheets</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script>
    const { useState, useEffect, createElement: h } = React;

    // Icon Components (SVG sederhana)
    const Trophy = ({ size = 24, className = '' }) => h('svg', {
      width: size,
      height: size,
      viewBox: '0 0 24 24',
      fill: 'none',
      stroke: 'currentColor',
      strokeWidth: 2,
      className
    }, 
      h('path', { d: 'M6 9H4.5a2.5 2.5 0 0 1 0-5H6' }),
      h('path', { d: 'M18 9h1.5a2.5 2.5 0 0 0 0-5H18' }),
      h('path', { d: 'M4 22h16' }),
      h('path', { d: 'M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22' }),
      h('path', { d: 'M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22' }),
      h('path', { d: 'M18 2H6v7a6 6 0 0 0 12 0V2Z' })
    );

    const Clock = ({ size = 24, className = '' }) => h('svg', {
      width: size,
      height: size,
      viewBox: '0 0 24 24',
      fill: 'none',
      stroke: 'currentColor',
      strokeWidth: 2,
      className
    },
      h('circle', { cx: '12', cy: '12', r: '10' }),
      h('polyline', { points: '12 6 12 12 16 14' })
    );

    const Plus = ({ size = 24, className = '' }) => h('svg', {
      width: size,
      height: size,
      viewBox: '0 0 24 24',
      fill: 'none',
      stroke: 'currentColor',
      strokeWidth: 2,
      className
    },
      h('path', { d: 'M5 12h14' }),
      h('path', { d: 'M12 5v14' })
    );

    const Trash2 = ({ size = 24, className = '' }) => h('svg', {
      width: size,
      height: size,
      viewBox: '0 0 24 24',
      fill: 'none',
      stroke: 'currentColor',
      strokeWidth: 2,
      className
    },
      h('path', { d: 'M3 6h18' }),
      h('path', { d: 'M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6' }),
      h('path', { d: 'M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2' })
    );

    const Settings = ({ size = 24, className = '' }) => h('svg', {
      width: size,
      height: size,
      viewBox: '0 0 24 24',
      fill: 'none',
      stroke: 'currentColor',
      strokeWidth: 2,
      className
    },
      h('path', { d: 'M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z' }),
      h('circle', { cx: '12', cy: '12', r: '3' })
    );

    const CheckCircle = ({ size = 24, className = '' }) => h('svg', {
      width: size,
      height: size,
      viewBox: '0 0 24 24',
      fill: 'none',
      stroke: 'currentColor',
      strokeWidth: 2,
      className
    },
      h('path', { d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14' }),
      h('polyline', { points: '22 4 12 14.01 9 11.01' })
    );

    const AlertCircle = ({ size = 24, className = '' }) => h('svg', {
      width: size,
      height: size,
      viewBox: '0 0 24 24',
      fill: 'none',
      stroke: 'currentColor',
      strokeWidth: 2,
      className
    },
      h('circle', { cx: '12', cy: '12', r: '10' }),
      h('line', { x1: '12', y1: '8', x2: '12', y2: '12' }),
      h('line', { x1: '12', y1: '16', x2: '12.01', y2: '16' })
    );

    const RefreshCw = ({ size = 24, className = '' }) => h('svg', {
      width: size,
      height: size,
      viewBox: '0 0 24 24',
      fill: 'none',
      stroke: 'currentColor',
      strokeWidth: 2,
      className
    },
      h('path', { d: 'M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8' }),
      h('path', { d: 'M21 3v5h-5' }),
      h('path', { d: 'M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16' }),
      h('path', { d: 'M3 21v-5h5' })
    );

    function TimerLeaderboard() {
      const [teams, setTeams] = useState([]);
      const [teamName, setTeamName] = useState('');
      const [minutes, setMinutes] = useState('');
      const [seconds, setSeconds] = useState('');
      const [errors, setErrors] = useState('0');
      const [loading, setLoading] = useState(true);
      const [syncing, setSyncing] = useState(false);
      const [webAppUrl, setWebAppUrl] = useState('');
      const [isConfigured, setIsConfigured] = useState(false);
      const [lastSync, setLastSync] = useState(null);
      const [showSetup, setShowSetup] = useState(false);

      useEffect(() => {
        loadConfig();
        loadData();
      }, []);

      const loadConfig = () => {
        try {
          const config = localStorage.getItem('sheets-config');
          if (config) {
            const parsed = JSON.parse(config);
            setWebAppUrl(parsed.webAppUrl || '');
            setIsConfigured(!!parsed.webAppUrl);
          }
        } catch (error) {
          console.log('Belum ada konfigurasi');
        }
      };

      const saveConfig = () => {
        if (!webAppUrl) {
          alert('Mohon isi Web App URL!');
          return;
        }
        try {
          localStorage.setItem('sheets-config', JSON.stringify({ webAppUrl }));
          setIsConfigured(true);
          setShowSetup(false);
          alert('✅ Konfigurasi berhasil! Auto-sync aktif.');
        } catch (error) {
          alert('❌ Gagal menyimpan: ' + error.message);
        }
      };

      const loadData = () => {
        try {
          const data = localStorage.getItem('timer-teams');
          if (data) {
            setTeams(JSON.parse(data));
          }
        } catch (error) {
          console.log('Belum ada data');
        } finally {
          setLoading(false);
        }
      };

      const saveData = (newTeams) => {
        try {
          localStorage.setItem('timer-teams', JSON.stringify(newTeams));
        } catch (error) {
          console.error('Gagal menyimpan:', error);
        }
      };

      const syncToSheets = async (dataToSync) => {
        if (!isConfigured || !webAppUrl) {
          return;
        }

        setSyncing(true);
        try {
          const payload = {
            teams: dataToSync.map((team, index) => ({
              rank: index + 1,
              name: team.name,
              originalTime: `${team.minutes}:${team.seconds.toString().padStart(2, '0')}`,
              errors: team.errors,
              penalty: team.penalty,
              finalTime: formatTime(Math.floor(team.finalTime / 60), team.finalTime % 60),
              finalSeconds: team.finalTime,
              timestamp: team.timestamp
            }))
          };

          await fetch(webAppUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            mode: 'no-cors'
          });

          setLastSync(new Date().toLocaleString('id-ID'));
        } catch (error) {
          console.error('Gagal sync:', error);
        } finally {
          setSyncing(false);
        }
      };

      const addTeam = async () => {
        if (!teamName.trim() || minutes === '' || seconds === '') {
          alert('Mohon isi nama tim, menit, dan detik!');
          return;
        }

        const numErrors = parseInt(errors) || 0;
        const totalSeconds = parseInt(minutes) * 60 + parseInt(seconds);
        const penalty = numErrors * 30;
        const finalTime = totalSeconds + penalty;
        
        const newTeam = {
          id: Date.now(),
          name: teamName.trim(),
          minutes: parseInt(minutes),
          seconds: parseInt(seconds),
          errors: numErrors,
          penalty: penalty,
          totalSeconds: totalSeconds,
          finalTime: finalTime,
          timestamp: new Date().toLocaleString('id-ID')
        };

        const updatedTeams = [...teams, newTeam].sort((a, b) => a.finalTime - b.finalTime);
        setTeams(updatedTeams);
        saveData(updatedTeams);

        if (isConfigured) {
          await syncToSheets(updatedTeams);
        }

        setTeamName('');
        setMinutes('');
        setSeconds('');
        setErrors('0');
      };

      const deleteTeam = async (id) => {
        const updatedTeams = teams.filter(team => team.id !== id);
        setTeams(updatedTeams);
        saveData(updatedTeams);
        
        if (isConfigured) {
          await syncToSheets(updatedTeams);
        }
      };

      const resetAll = async () => {
        if (window.confirm('Hapus semua data?')) {
          setTeams([]);
          saveData([]);
          
          if (isConfigured) {
            await syncToSheets([]);
          }
        }
      };

      const formatTime = (mins, secs) => {
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      if (loading) {
        return h('div', { className: 'min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center' },
          h('div', { className: 'text-white text-xl' }, 'Memuat data...')
        );
      }

      return h('div', { className: 'min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 p-4 pb-20' },
        h('div', { className: 'max-w-5xl mx-auto' },
          // Header
          h('div', { className: 'bg-white rounded-t-3xl shadow-2xl p-6 mb-1' },
            h('div', { className: 'flex items-center justify-between' },
              h('div', { className: 'flex items-center gap-3' },
                h(Trophy, { size: 36, className: 'text-yellow-500' }),
                h('div', null,
                  h('h1', { className: 'text-3xl font-bold text-gray-800' }, 'Timer Leaderboard'),
                  h('p', { className: 'text-sm text-gray-600' }, 'Auto-Sync ke Google Sheets ✨')
                )
              ),
              h('button', {
                onClick: () => setShowSetup(!showSetup),
                className: `p-3 rounded-lg transition-colors ${isConfigured ? 'bg-green-100 text-green-600 hover:bg-green-200' : 'bg-red-100 text-red-600 hover:bg-red-200 animate-pulse'}`
              }, h(isConfigured ? CheckCircle : Settings, { size: 24 }))
            ),
            
            isConfigured && h('div', { className: 'mt-4 flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3' },
              h('div', { className: 'flex items-center gap-2 text-sm text-green-700' },
                h(CheckCircle, { size: 16 }),
                h('span', null, 'Terhubung ke Google Sheets'),
                lastSync && h('span', { className: 'text-xs text-green-600' }, `• ${lastSync}`)
              ),
              h('button', {
                onClick: () => syncToSheets(teams),
                disabled: syncing,
                className: 'bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm flex items-center gap-1 disabled:opacity-50'
              },
                h(RefreshCw, { size: 14, className: syncing ? 'animate-spin' : '' }),
                syncing ? 'Syncing...' : 'Sync Manual'
              )
            ),

            !isConfigured && h('div', { className: 'mt-4 bg-red-50 border border-red-200 rounded-lg p-3' },
              h('p', { className: 'text-sm text-red-700 font-semibold' }, '⚠️ Belum terkonfigurasi!'),
              h('p', { className: 'text-xs text-red-600' }, 'Klik ikon Settings untuk setup Google Sheets')
            )
          ),

          // Setup Panel
          showSetup && h('div', { className: 'bg-white shadow-2xl p-6 mb-1 border-l-4 border-blue-500' },
            h('h2', { className: 'text-xl font-semibold text-gray-800 mb-4' }, 'Setup Google Sheets'),
            h('div', { className: 'mb-4' },
              h('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Web App URL:'),
              h('input', {
                type: 'text',
                value: webAppUrl,
                onChange: (e) => setWebAppUrl(e.target.value),
                placeholder: 'https://script.google.com/macros/s/.../exec',
                className: 'w-full px-4 py-2 border-2 border-gray-300 rounded-lg text-sm'
              }),
              h('p', { className: 'text-xs text-gray-500 mt-2' }, 'Deploy Google Apps Script sebagai Web App, lalu paste URL-nya di sini')
            ),
            h('div', { className: 'flex gap-2' },
              h('button', {
                onClick: saveConfig,
                className: 'flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg'
              }, 'Simpan'),
              h('button', {
                onClick: () => setShowSetup(false),
                className: 'px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg'
              }, 'Tutup')
            )
          ),

          // Form Input
          h('div', { className: 'bg-white shadow-2xl p-6 mb-1' },
            h('h2', { className: 'text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2' },
              h(Plus, { size: 24, className: 'text-blue-500' }),
              'Tambah Data Tim'
            ),
            h('div', { className: 'space-y-4' },
              h('div', null,
                h('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Nama Tim'),
                h('input', {
                  type: 'text',
                  value: teamName,
                  onChange: (e) => setTeamName(e.target.value),
                  onKeyPress: (e) => e.key === 'Enter' && addTeam(),
                  placeholder: 'Masukkan nama tim',
                  className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg'
                })
              ),
              h('div', { className: 'grid grid-cols-3 gap-4' },
                h('div', null,
                  h('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Menit'),
                  h('input', {
                    type: 'number',
                    min: '0',
                    value: minutes,
                    onChange: (e) => setMinutes(e.target.value),
                    placeholder: '0',
                    className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg'
                  })
                ),
                h('div', null,
                  h('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Detik'),
                  h('input', {
                    type: 'number',
                    min: '0',
                    max: '59',
                    value: seconds,
                    onChange: (e) => setSeconds(e.target.value),
                    placeholder: '0',
                    className: 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg'
                  })
                ),
                h('div', null,
                  h('label', { className: 'block text-sm font-medium text-gray-700 mb-1 flex items-center gap-1' },
                    h(AlertCircle, { size: 14, className: 'text-red-500' }),
                    'Kesalahan'
                  ),
                  h('input', {
                    type: 'number',
                    min: '0',
                    value: errors,
                    onChange: (e) => setErrors(e.target.value),
                    placeholder: '0',
                    className: 'w-full px-4 py-3 border-2 border-red-200 rounded-lg'
                  })
                )
              ),
              parseInt(errors) > 0 && h('div', { className: 'bg-orange-50 border border-orange-200 rounded-lg p-3' },
                h('div', { className: 'flex items-center gap-2 text-sm text-orange-800' },
                  h(AlertCircle, { size: 16 }),
                  h('span', { className: 'font-semibold' }, `Penalti: +${parseInt(errors) * 30} detik`),
                  h('span', { className: 'text-xs text-orange-600' }, `(${errors} kesalahan × 30 detik)`)
                )
              ),
              h('button', {
                onClick: addTeam,
                disabled: syncing,
                className: 'w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50 flex items-center justify-center gap-2'
              },
                h(Plus, { size: 20 }),
                syncing ? 'Menyimpan & Sync...' : 'Tambah Tim & Sync'
              )
            )
          ),

          // Leaderboard
          h('div', { className: 'bg-white rounded-b-3xl shadow-2xl p-6' },
            h('div', { className: 'flex justify-between items-center mb-4' },
              h('h2', { className: 'text-xl font-semibold text-gray-800 flex items-center gap-2' },
                h(Clock, { size: 24, className: 'text-blue-500' }),
                `Peringkat Tim (${teams.length})`
              ),
              teams.length > 0 && h('button', {
                onClick: resetAll,
                disabled: syncing,
                className: 'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm disabled:opacity-50'
              },
                h(Trash2, { size: 16 }),
                'Reset'
              )
            ),
            teams.length === 0 ? h('div', { className: 'text-center py-12 text-gray-400' },
              h(Clock, { size: 64, className: 'mx-auto mb-4 opacity-50' }),
              h('p', { className: 'text-lg' }, 'Belum ada data tim'),
              h('p', { className: 'text-sm' }, 'Tambahkan tim pertama!')
            ) : h('div', { className: 'overflow-x-auto' },
              h('table', { className: 'w-full' },
                h('thead', null,
                  h('tr', { className: 'border-b-2 border-gray-200' },
                    h('th', { className: 'py-3 px-3 text-left font-semibold text-gray-700' }, 'Rank'),
                    h('th', { className: 'py-3 px-4 text-left font-semibold text-gray-700' }, 'Nama Tim'),
                    h('th', { className: 'py-3 px-3 text-center font-semibold text-gray-700' }, 'Waktu Asli'),
                    h('th', { className: 'py-3 px-3 text-center font-semibold text-gray-700' }, 'Kesalahan'),
                    h('th', { className: 'py-3 px-3 text-center font-semibold text-gray-700' }, 'Penalti'),
                    h('th', { className: 'py-3 px-3 text-center font-semibold text-gray-700' }, 'Waktu Final'),
                    h('th', { className: 'py-3 px-3 text-center font-semibold text-gray-700 text-xs' }, 'Tanggal'),
                    h('th', { className: 'py-3 px-3 text-center font-semibold text-gray-700' }, 'Aksi')
                  )
                ),
                h('tbody', null,
                  teams.map((team, index) =>
                    h('tr', {
                      key: team.id,
                      className: `border-b border-gray-100 hover:bg-gray-50 ${index === 0 ? 'bg-yellow-50' : ''}`
                    },
                      h('td', { className: 'py-3 px-3' },
                        h('div', { className: 'flex items-center gap-2' },
                          index === 0 && h(Trophy, { size: 18, className: 'text-yellow-500' }),
                          h('span', { className: `font-bold ${index === 0 ? 'text-yellow-600 text-lg' : 'text-gray-600'}` }, `#${index + 1}`)
                        )
                      ),
                      h('td', { className: 'py-3 px-4' },
                        h('span', { className: index === 0 ? 'font-bold text-gray-800' : 'text-gray-700' }, team.name)
                      ),
                      h('td', { className: 'py-3 px-3 text-center' },
                        h('span', { className: 'font-mono text-gray-600 text-sm' }, formatTime(team.minutes, team.seconds))
                      ),
                      h('td', { className: 'py-3 px-3 text-center' },
                        team.errors > 0 ? h('span', { className: 'inline-flex items-center gap-1 bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-semibold' },
                          h(AlertCircle, { size: 12 }),
                          team.errors
                        ) : h('span', { className: 'text-green-600 text-sm' }, '-')
                      ),
                      h('td', { className: 'py-3 px-3 text-center' },
                        team.penalty > 0 ? h('span', { className: 'text-orange-600 font-semibold text-sm' }, `+${team.penalty}s`) : h('span', { className: 'text-gray-400 text-sm' }, '-')
                      ),
                      h('td', { className: 'py-3 px-3 text-center' },
                        h('span', { className: `font-mono font-bold ${index === 0 ? 'text-yellow-600 text-xl' : 'text-blue-600 text-lg'}` },
                          formatTime(Math.floor(team.finalTime / 60), team.finalTime % 60)
                        )
                      ),
                      h('td', { className: 'py-3 px-3 text-center text-xs text-gray-500' }, team.timestamp.split(' ')[1]),
                      h('td', { className: 'py-3 px-3 text-center' },
                        h('button', {
                          onClick: () => deleteTeam(team.id),
                          disabled: syncing,
                          className: 'text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg disabled:opacity-50'
                        }, h(Trash2, { size: 16 }))
                      )
                    )
                  )
                )
              )
            )
          ),

          // Footer
          h('div', { className: 'mt-4 text-center text-white text-sm space-y-1' },
            h('p', null, '✨ Data tersinkronisasi otomatis ke Google Sheets'),
            h('p', { className: 'text-xs opacity-80' }, 'Setiap kesalahan menambah penalti +30 detik')
          )
        )
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(TimerLeaderboard));
  </script>
</body>
</html>
